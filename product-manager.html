<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Shop | Product & Performance Manager</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { 
            --bg-dark: #0f172a; 
            --card-bg: #1e293b; 
            --accent: #00ffcc; 
            --text-main: #f8fafc; 
            --sidebar-width: 240px;
            --primary: #1e293b; 
            --success: #22c55e; 
            --danger: #ef4444; 
            --warning: #f59e0b; 
            --bulk: #8b5cf6; 
        }
        
        body { font-family: 'Segoe UI', sans-serif; background-color: var(--bg-dark); color: var(--text-main); margin: 0; display: flex; flex-direction: column; }
        
        /* Sidebar Layout Fix */
        .sidebar { 
            width: var(--sidebar-width); background: #020617; height: 100vh; position: fixed; 
            left: 0; top: 0; padding: 20px; border-right: 1px solid #334155; z-index: 1000; transition: 0.3s;
        }
        .sidebar h2 { color: var(--accent); margin-bottom: 30px; font-size: 1.4rem; }
        .nav-item { display: flex; align-items: center; padding: 12px 15px; color: #94a3b8; text-decoration: none; border-radius: 8px; margin-bottom: 10px; }
        .nav-item.active { background: #111d2e; color: var(--accent); border: 1px solid #1e293b; }
        .nav-item i { margin-right: 15px; width: 20px; }

        .main-content { 
            margin-left: var(--sidebar-width); padding: 20px; width: calc(100% - var(--sidebar-width)); 
            box-sizing: border-box; transition: 0.3s;
        }

        /* Stats & Cards */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .card { background: var(--card-bg); padding: 20px; border-radius: 12px; border: 1px solid #334155; }
        
        .discount-highlight { color: var(--danger); font-weight: bold; font-size: 1.8rem; margin: 10px 0; }
        .alert-box { background: #451a1a; border-left: 6px solid var(--warning); padding: 15px; border-radius: 8px; margin-bottom: 20px; display: none; }
        .stock-tag { background: #334155; color: #ffedd5; padding: 4px 10px; border-radius: 20px; font-size: 0.85rem; display: inline-block; margin: 4px; border: 1px solid #f59e0b; }

        /* Toolbar */
        .toolbar { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .search-bar { flex: 1; min-width: 250px; padding: 12px; border-radius: 8px; border: 1px solid #334155; background: #0f172a; color: white; font-size: 16px; }

        .btn { padding: 10px 20px; border-radius: 8px; border: none; cursor: pointer; font-weight: bold; color: white; display: flex; align-items: center; gap: 8px; font-size: 0.9rem; }
        .btn-export { background: #16a34a; }
        .btn-import { background: var(--bulk); }
        .btn-update { background: var(--success); width: 100%; margin-top: 10px; }

        /* Responsive Table */
        .table-container { background: var(--card-bg); border-radius: 12px; border: 1px solid #334155; overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; min-width: 900px; }
        th { background: #020617; color: var(--accent); padding: 12px; text-align: left; font-size: 0.8rem; text-transform: uppercase; }
        td { padding: 12px; border-bottom: 1px solid #334155; font-size: 0.9rem; }
        
        input[type="number"] { width: 80px; padding: 8px; border-radius: 6px; border: 1px solid #334155; background: #0f172a; color: white; }
        .add-stock-input { border: 2px solid var(--accent) !important; background: #111d2e; }

        /* Activity Log */
        .log-container { max-height: 150px; overflow-y: auto; background: #020617; border-radius: 8px; padding: 10px; font-family: monospace; }
        .log-entry { color: #94a3b8; font-size: 0.8rem; border-bottom: 1px solid #1e293b; padding: 5px 0; display: flex; justify-content: space-between; }

        /* Mobile Adaptations */
        @media (max-width: 1024px) {
            :root { --sidebar-width: 70px; }
            .sidebar h2, .nav-item span { display: none; }
            .nav-item { justify-content: center; padding: 15px 5px; }
            .main-content { margin-left: 70px; width: calc(100% - 70px); }
        }

        @media (max-width: 768px) {
            table { min-width: 100%; }
            thead { display: none; }
            tr { display: block; margin-bottom: 20px; border: 1px solid #334155; border-radius: 10px; padding: 10px; background: #111d2e; }
            td { display: flex; justify-content: space-between; border: none; padding: 8px 5px; border-bottom: 1px solid #1e293b; }
            td::before { content: attr(data-label); font-weight: bold; color: var(--accent); font-size: 0.75rem; }
            .chart-container { height: 200px; }
        }
        #fileInput { display: none; }
    </style>
</head>
<body>

    <nav class="sidebar">
        <h2>Smart Shop</h2>
        <a href="admin.html" class="nav-item"><i class="fas fa-chart-line"></i> <span>Dashboard</span></a>
        <a href="inventory.html" class="nav-item active"><i class="fas fa-boxes"></i> <span>Inventory</span></a>
        <a href="suppliers.html" class="nav-item"><i class="fas fa-truck"></i> <span>Suppliers</span></a>
    </nav>

    <main class="main-content">
        <div id="stockAlert" class="alert-box">
            <h3 style="margin-top:0">‚ö†Ô∏è Low Stock Warning</h3>
            <div id="lowStockList"></div>
        </div>

        <div class="stats-grid">
            <div class="card">
                <h2>üìä Top 5 Sales</h2>
                <div class="chart-container"><canvas id="salesChart"></canvas></div>
            </div>
            <div class="card" style="border-left: 5px solid var(--bulk);">
                <h2>üìâ Bulk Discounts</h2>
                <div class="discount-highlight" id="total-discounts">KES 0.00</div>
                <small style="color: #94a3b8;">Revenue difference from bulk sales</small>
            </div>
        </div>

        <div class="card">
            <h2>‚öôÔ∏è Inventory & Bulk Pricing</h2>
            <div class="toolbar">
                <input type="text" id="mgrSearch" class="search-bar" placeholder="üîç Search products or categories...">
                <button class="btn btn-export" id="exportBtn"><i class="fas fa-file-excel"></i> Export</button>
                <label class="btn btn-import" for="fileInput"><i class="fas fa-upload"></i> Bulk Upload</label>
                <input type="file" id="fileInput" accept=".xlsx, .xls, .csv">
            </div>

            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Product Details</th>
                            <th>Stock</th>
                            <th>+ Add</th>
                            <th>Selling Price</th>
                            <th>Min. Floor</th>
                            <th style="background: var(--bulk); color:white">Bulk Qty</th>
                            <th style="background: var(--bulk); color:white">Bulk Price</th>
                            <th>Profit</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="inventory-body">
                        <tr><td colspan="9" style="text-align:center">Syncing Database...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="card" style="margin-top:20px">
            <h2>üìù Activity Log</h2>
            <div class="log-container" id="activityLog"></div>
        </div>
    </main>

<script type="module">
    import { supabase } from './auth.js';

    let salesChart;
    let allProducts = [];

    // Feature Restore: Blocked List
    const blockedItems = ["Internal Fee", "Maintenance"];

    async function loadManager() {
        const { data: products } = await supabase.from('products').select('*').order('name');
        const { data: sales } = await supabase.from('sales').select('*');

        if (products) {
            allProducts = products.filter(p => !blockedItems.includes(p.name));
            renderTable(allProducts);
            checkLowStock(allProducts);
            if (sales) {
                renderChart(sales);
                calculateBulkImpact(sales, products);
            }
        }
    }

    function renderTable(products) {
        const tbody = document.getElementById('inventory-body');
        tbody.innerHTML = products.map(p => {
            const profit = (p.unit_price - (p.cost_price || 0)).toFixed(2);
            return `
            <tr>
                <td data-label="Product"><strong>${p.name}</strong><br><small style="color:#94a3b8">${p.product_type || 'General'}</small></td>
                <td data-label="In Stock" style="color: ${p.stock_quantity <= 5 ? 'var(--danger)' : 'var(--accent)'}; font-weight: bold;">${p.stock_quantity}</td>
                <td data-label="Restock"><input type="number" id="add-${p.id}" class="add-stock-input" placeholder="0"></td>
                <td data-label="Selling Price"><input type="number" id="up-${p.id}" value="${p.unit_price}"></td>
                <td data-label="Min Floor"><input type="number" id="mp-${p.id}" value="${p.min_price || 0}"></td>
                <td data-label="Bulk Qty"><input type="number" id="bt-${p.id}" value="${p.bulk_threshold || ''}"></td>
                <td data-label="Bulk KES"><input type="number" id="bp-${p.id}" value="${p.bulk_price || ''}"></td>
                <td data-label="Profit Unit"><span style="color:var(--success)">KES ${profit}</span></td>
                <td><button class="btn btn-update" onclick="updateProduct('${p.id}', ${p.stock_quantity}, '${p.name}')">Save</button></td>
            </tr>
        `}).join('');
    }

    // Feature Restore: Bulk Excel Import
    document.getElementById('fileInput').onchange = async (e) => {
        const file = e.target.files[0];
        const reader = new FileReader();
        reader.onload = async (evt) => {
            const data = evt.target.result;
            const workbook = XLSX.read(data, { type: 'binary' });
            const rows = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
            if(confirm(`Apply updates to ${rows.length} products?`)) {
                for (let row of rows) {
                    if (row.ID) {
                        await supabase.from('products').update({
                            unit_price: row["Selling Price"],
                            bulk_threshold: row["Bulk Threshold"],
                            bulk_price: row["Bulk Price"]
                        }).eq('id', row.ID);
                    }
                }
                addLog(`Bulk Update: ${rows.length} items modified.`);
                loadManager();
            }
        };
        reader.readAsBinaryString(file);
    };

    // Feature Restore: Excel Export
    document.getElementById('exportBtn').onclick = () => {
        const data = allProducts.map(p => ({
            "ID": p.id, "Name": p.name, "Stock": p.stock_quantity, 
            "Selling Price": p.unit_price, "Bulk Threshold": p.bulk_threshold, "Bulk Price": p.bulk_price
        }));
        const ws = XLSX.utils.json_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Stock");
        XLSX.writeFile(wb, "SmartShop_Inventory.xlsx");
        addLog("Exported inventory to Excel.");
    };

    window.updateProduct = async (id, currentStock, name) => {
        const addQty = parseInt(document.getElementById(`add-${id}`).value || 0);
        const finalStock = currentStock + addQty;
        const { error } = await supabase.from('products').update({ 
            unit_price: parseFloat(document.getElementById(`up-${id}`).value),
            min_price: parseFloat(document.getElementById(`mp-${id}`).value),
            stock_quantity: finalStock,
            bulk_threshold: document.getElementById(`bt-${id}`).value || null,
            bulk_price: document.getElementById(`bp-${id}`).value || null
        }).eq('id', id);

        if (!error) { 
            addLog(`Updated ${name} (New Stock: ${finalStock})`);
            loadManager(); 
        } else alert(error.message);
    };

    function calculateBulkImpact(sales, products) {
        let impact = 0;
        sales.forEach(s => {
            const p = products.find(i => i.name === s.item_name);
            if (p) {
                const expected = s.quantity * p.unit_price;
                if (s.total_amount < expected) impact += (expected - s.total_amount);
            }
        });
        document.getElementById('total-discounts').innerText = `KES ${impact.toLocaleString()}`;
    }

    function checkLowStock(products) {
        const low = products.filter(p => p.stock_quantity <= 5);
        const box = document.getElementById('stockAlert');
        if (low.length > 0) {
            box.style.display = 'block';
            document.getElementById('lowStockList').innerHTML = low.map(p => `<span class="stock-tag">${p.name}: ${p.stock_quantity}</span>`).join('');
        } else box.style.display = 'none';
    }

    function renderChart(salesData) {
        const counts = {};
        salesData.forEach(s => counts[s.item_name] = (counts[s.item_name] || 0) + s.quantity);
        const top = Object.entries(counts).sort((a,b) => b[1]-a[1]).slice(0,5);
        const ctx = document.getElementById('salesChart').getContext('2d');
        if (salesChart) salesChart.destroy();
        salesChart = new Chart(ctx, {
            type: 'bar',
            data: { labels: top.map(x=>x[0]), datasets: [{ label: 'Qty', data: top.map(x=>x[1]), backgroundColor: '#00ffcc' }] },
            options: { responsive: true, maintainAspectRatio: false, color: '#94a3b8' }
        });
    }

    function addLog(msg) {
        const log = document.getElementById('activityLog');
        const time = new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
        log.innerHTML = `<div class="log-entry"><span>${msg}</span><span>${time}</span></div>` + log.innerHTML;
    }

    document.getElementById('mgrSearch').oninput = (e) => {
        const term = e.target.value.toLowerCase();
        renderTable(allProducts.filter(p => p.name.toLowerCase().includes(term)));
    };

    loadManager();
</script>
</body>
</html>