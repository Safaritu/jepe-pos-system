<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Gas POS | Secure Terminal</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { 
            --danger: #ef4444; 
            --success: #00ffcc; 
            --dark: #0b0f1a; 
            --card-bg: #161b2c; 
            --text-main: #f8fafc; 
            --border: #2d3748;
            --accent: #3b82f6;
            --warning: #f59e0b;
        }
        
        * { box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--dark); color: var(--text-main); margin: 0; padding: 15px; display: flex; justify-content: center; }
        
        .pos-container { width: 100%; max-width: 500px; background: var(--card-bg); padding: 25px; border-radius: 24px; border: 1px solid var(--border); box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5); }
        
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid var(--border); padding-bottom: 15px; }
        .logo { font-size: 1.3rem; font-weight: bold; color: var(--success); display: flex; align-items: center; gap: 10px; }

        /* Stock Alert Styling */
        .alert-bell { color: var(--danger); animation: ring 0.5s infinite; display: none; }
        @keyframes ring {
            0% { transform: rotate(0); } 25% { transform: rotate(15deg); } 50% { transform: rotate(-15deg); } 75% { transform: rotate(10deg); } 100% { transform: rotate(0); }
        }
        
        .stock-summary { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 20px; padding: 12px; background: rgba(0,0,0,0.3); border-radius: 15px; }
        .summary-item { text-align: center; font-size: 0.7rem; border-right: 1px solid var(--border); }
        .summary-item:last-child { border-right: none; }
        .summary-item div { font-weight: 800; font-size: 1.1rem; margin-top: 4px; }
        .f-text { color: var(--success); }
        .e-text { color: #64748b; }
        
        /* Monitor Section */
        .stock-monitor { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-bottom: 20px; }
        .monitor-card { background: #0b0f1a; padding: 8px; border-radius: 12px; border: 1px solid var(--border); text-align: center; transition: 0.3s; }
        .monitor-card.selected { border-color: var(--success); background: rgba(0, 255, 204, 0.05); }
        
        /* LOW STOCK HIGHLIGHTING */
        .monitor-card.low { 
            border: 2px solid var(--danger) !important; 
            background: rgba(239, 68, 68, 0.15); 
            animation: pulse-red 2s infinite;
        }
        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }

        .monitor-card b { color: var(--success); display: block; font-size: 1.1rem; }
        .monitor-card.low b { color: var(--danger); }

        /* Form Styling */
        .form-group { display: flex; flex-direction: column; gap: 6px; margin-bottom: 15px; }
        .form-group label { font-size: 0.7rem; color: #94a3b8; font-weight: bold; text-transform: uppercase; }
        
        select, input { background: #0b0f1a; border: 1px solid var(--border); color: white; padding: 14px; border-radius: 12px; font-size: 16px; width: 100%; outline: none; }
        select:focus, input:focus { border-color: var(--accent); }

        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }

        /* Payment Buttons */
        .payment-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-top: 5px; }
        .pay-btn { background: #0b0f1a; border: 1px solid var(--border); color: #94a3b8; padding: 10px 2px; border-radius: 10px; cursor: pointer; text-align: center; font-size: 0.65rem; font-weight: bold; }
        .pay-btn i { display: block; font-size: 1rem; margin-bottom: 4px; }
        .pay-btn.active { background: var(--accent); color: white; border-color: var(--accent); }

        /* Price Display */
        .price-display { background: #000; padding: 25px; border-radius: 20px; text-align: center; margin: 20px 0; border: 2px solid var(--border); }
        .price-display.warning { border-color: var(--danger); box-shadow: 0 0 15px rgba(239, 68, 68, 0.2); }
        .warning-text { color: var(--danger); font-size: 0.75rem; font-weight: bold; margin-bottom: 8px; display: none; }
        
        #grandTotal { font-size: 2.5rem; font-weight: 900; color: white; display: block; letter-spacing: -1px; }
        
        .btn-complete { width: 100%; background: var(--success); color: #0b0f1a; border: none; padding: 18px; border-radius: 15px; font-size: 1.1rem; font-weight: 800; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; transition: 0.2s; }
        .btn-complete:active { transform: scale(0.98); }
    </style>
</head>
<body>

<div class="pos-container">
    <div class="header">
        <div class="logo"><i class="fas fa-gas-pump"></i> TERMINAL <i id="stockBell" class="fas fa-bell alert-bell"></i></div>
        <div id="userEmail" style="font-size: 0.7rem; color: #718096; opacity: 0.8;"></div>
    </div>

    <div class="stock-summary">
        <div class="summary-item">6KG <br> <span class="f-text">F:<span id="f6">0</span></span> <span class="e-text">E:<span id="e6">0</span></span></div>
        <div class="summary-item">13KG <br> <span class="f-text">F:<span id="f13">0</span></span> <span class="e-text">E:<span id="e13">0</span></span></div>
        <div class="summary-item">50KG <br> <span class="f-text">F:<span id="f50">0</span></span> <span class="e-text">E:<span id="e50">0</span></span></div>
    </div>

    <div id="monitor" class="stock-monitor"></div>

    <div class="form-group">
        <label>Select Brand</label>
        <select id="brandSelector" onchange="updateUI()"></select>
    </div>

    <div class="form-grid">
        <div class="form-group">
            <label>Cylinder Size</label>
            <select id="sizeSelector" onchange="updateUI()">
                <option value="6">6 KG</option>
                <option value="13">13 KG</option>
                <option value="50">50 KG</option>
            </select>
        </div>
        <div class="form-group">
            <label>Quantity</label>
            <input type="number" id="saleQty" value="1" min="1" oninput="updateUI()">
        </div>
    </div>

    <div class="form-grid">
        <div class="form-group">
            <label>Transaction Type</label>
            <select id="saleType" onchange="updateUI()">
                <option value="Refill">Refill / Swap</option>
                <option value="New">New Purchase</option>
            </select>
        </div>
        <div class="form-group">
            <label>Unit Price</label>
            <input type="number" id="unitPrice" oninput="updateUI()">
        </div>
    </div>

    <div class="form-group">
        <label>Payment Mode</label>
        <div class="payment-grid">
            <div class="pay-btn active" onclick="setPayment('Cash', this)"><i class="fas fa-money-bill-wave"></i> CASH</div>
            <div id="payKcb" class="pay-btn" onclick="setPayment('KCB', this)"><i class="fas fa-university"></i> KCB</div>
            <div id="payEquity" class="pay-btn" onclick="setPayment('Equity', this)"><i class="fas fa-credit-card"></i> EQUITY</div>
        </div>
    </div>

    <div class="price-display" id="totalBox">
        <div id="pinWarning" class="warning-text"><i class="fas fa-lock"></i> PRICE BELOW MINIMUM - PIN REQ</div>
        <span style="color: #64748b; font-size: 0.75rem; font-weight: bold; text-transform: uppercase;">Total Payable</span>
        <span id="grandTotal">KES 0</span>
    </div>

    <button class="btn-complete" id="submitBtn" onclick="processSale()">
        <i class="fas fa-cart-arrow-down"></i> CONFIRM SALE
    </button>
</div>

<script type="module">
    import { supabase } from './auth.js';
    
    let inventory = [];
    let currentUser = null;
    let selectedPayment = 'Cash';
    let minAllowedPrice = 0;

    // AUDIO ALERT: Plays a beep sound for low stock
    function playAlertSound() {
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        
        // Short high-pitched double beep
        const playBeep = (delay) => {
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.frequency.setValueAtTime(900, audioCtx.currentTime + delay);
            gain.gain.setValueAtTime(0.1, audioCtx.currentTime + delay);
            osc.start(audioCtx.currentTime + delay);
            osc.stop(audioCtx.currentTime + delay + 0.15);
        };

        playBeep(0);
        playBeep(0.3);
    }

    async function init() {
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) { window.location.href = 'index.html'; return; }
        currentUser = user;
        document.getElementById('userEmail').innerText = user.email;
        await loadStock();
    }

    async function loadStock() {
        const { data, error } = await supabase.from('gas_stock').select('*').order('brand_name');
        if (error) return;
        
        inventory = data || [];
        calculateAggregates();
        
        const brands = [...new Set(inventory.map(i => i.brand_name))];
        const selector = document.getElementById('brandSelector');
        selector.innerHTML = brands.map(b => `<option value="${b}">${b.toUpperCase()}</option>`).join('');

        updateUI(true);
    }

    function calculateAggregates() {
        let totals = { 6: {f:0, e:0}, 13: {f:0, e:0}, 50: {f:0, e:0} };
        
        // Critical Stock Level threshold is 5 units
        let lowItems = inventory.filter(item => item.full_stock < 5);

        inventory.forEach(item => {
            if (totals[item.size_kg]) {
                totals[item.size_kg].f += (item.full_stock || 0);
                totals[item.size_kg].e += (item.empty_stock || 0);
            }
        });

        [6, 13, 50].forEach(size => {
            document.getElementById(`f${size}`).innerText = totals[size].f;
            document.getElementById(`e${size}`).innerText = totals[size].e;
        });

        // Trigger Alert if any item is low
        if (lowItems.length > 0) {
            document.getElementById('stockBell').style.display = 'inline-block';
            // Sound only plays on first load or refresh to avoid annoyance
            playAlertSound();
        } else {
            document.getElementById('stockBell').style.display = 'none';
        }
    }

    function renderMonitor(selectedItem = null) {
        let displayItems = [];
        if (selectedItem) displayItems.push(selectedItem);
        
        const others = inventory
            .filter(i => !selectedItem || i.id !== selectedItem.id)
            .sort((a, b) => a.full_stock - b.full_stock)
            .slice(0, selectedItem ? 3 : 4);

        displayItems = [...displayItems, ...others];

        document.getElementById('monitor').innerHTML = displayItems.map(item => `
            <div class="monitor-card ${item.id === selectedItem?.id ? 'selected' : ''} ${item.full_stock < 5 ? 'low' : ''}">
                <div style="font-size:0.6rem; color:#718096; white-space:nowrap; overflow:hidden;">${item.brand_name.toUpperCase()}</div>
                <b>${item.full_stock}</b>
            </div>
        `).join('');
    }

    window.setPayment = (method, btn) => {
        selectedPayment = method;
        document.querySelectorAll('.pay-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
    };

    window.updateUI = (first = false) => {
        const brand = document.getElementById('brandSelector').value;
        const size = document.getElementById('sizeSelector').value;
        const qty = document.getElementById('saleQty').value || 1;
        const item = inventory.find(i => i.brand_name === brand && i.size_kg == size);
        
        if (item) {
            renderMonitor(item);
            minAllowedPrice = item.min_price || 0;
            if (first) document.getElementById('unitPrice').value = item.selling_price;
            const price = parseFloat(document.getElementById('unitPrice').value) || 0;
            const isTooLow = price < minAllowedPrice && price > 0;
            document.getElementById('totalBox').className = isTooLow ? 'price-display warning' : 'price-display';
            document.getElementById('pinWarning').style.display = isTooLow ? 'block' : 'none';
            document.getElementById('grandTotal').innerText = `KES ${(price * qty).toLocaleString()}`;
        }
    };

    window.processSale = async () => {
        const brand = document.getElementById('brandSelector').value;
        const size = document.getElementById('sizeSelector').value;
        const qty = parseInt(document.getElementById('saleQty').value);
        const price = parseFloat(document.getElementById('unitPrice').value);
        const type = document.getElementById('saleType').value;
        const item = inventory.find(i => i.brand_name === brand && i.size_kg == size);

        if (!item || item.full_stock < qty || price <= 0) return alert("Check stock/price details");

        let saleNote = "";
        if (price < minAllowedPrice) {
            if (prompt("Enter Admin PIN:") !== "1234") return alert("Invalid PIN");
            saleNote = prompt("Reason for Discount:");
        }

        const btn = document.getElementById('submitBtn');
        btn.disabled = true;
        btn.innerText = "Processing...";

        try {
            await supabase.from('sales').insert({
                item_name: `GAS: ${brand.toUpperCase()} ${size}KG (${type})`,
                quantity: qty, unit_price: price, total_amount: price * qty,
                payment_method: selectedPayment, user_id: currentUser.id,
                product_id: item.id, sale_category: 'gas', notes: saleNote
            });

            await supabase.from('gas_stock').update({ 
                full_stock: item.full_stock - qty, 
                empty_stock: type === 'Refill' ? (item.empty_stock + qty) : item.empty_stock 
            }).eq('id', item.id);

            alert("Sale Confirmed!");
            location.reload();
        } catch (e) { 
            alert("Connection error"); 
            btn.disabled = false; 
            btn.innerText = "CONFIRM SALE";
        }
    };

    init();
</script>
</body>
</html>